import{_ as e,I as t,D as a,r as l,N as o,O as n,a as s,c as i,e as u,w as c,p as d,x as r,H as m,i as f,h as p,P as _,Q as w,R as v,S as y,T as h,d as b,f as k,k as q,t as C,g as x,B as I,F as $,m as V,C as g,z as A,n as z}from"./index-BIrkV5je.js";import{u as B}from"./department.DSvR3flN.js";const S=e({__name:"user-questionnaires",setup(e){const S=t(),F=S.query.questionnaireId,T=S.query.username,U=a("authToken"),j=l(null),D=B().getDepartmentDetail().id,O=o({title:"",description:""}),P=l([]),R=l([]);l([]);const H=l([]),N=o({content:"",viewable:1}),Q=l(null),E=l([]),G=l(!1),J=o({id:null,content:"",viewable:1}),K=l(!1);async function L(){const e=await d({url:`/comment/view/finish?finishId=${j.value}`,header:{"content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${U}`}});Array.isArray(e.data)?E.value=e.data:null!==e.data&&void 0!==e.data?E.value=[e.data]:E.value=[]}async function M(){const e=await d({url:"/comment/create",header:{"content-type":"application/json",Authorization:`Bearer ${U}`},method:"POST",data:{content:N.content,finishId:j.value,viewable:N.viewable}});200===e.code?(r({title:"评论创建成功",icon:"success"}),G.value=!1,N.content="",N.viewable=1,await L(),setTimeout((()=>{G.value=!1}),100)):409===e.code?r({title:"您已对该问卷发表评论",icon:"none"}):r({title:"评论创建失败",icon:"none"})}async function W(){try{200===(await d({url:"/comment/update",header:{"content-type":"application/json",Authorization:`Bearer ${U}`},method:"POST",data:{id:J.id,content:J.content,finishId:j.value,viewable:J.viewable}})).code?(r({title:"评论更新成功",icon:"success"}),K.value=!1,await L()):r({title:"评论更新失败",icon:"none"})}catch(e){console.error("更新评论失败:",e),r({title:"评论更新失败",icon:"none"})}}async function X(){try{const e=await d({url:`/answer/view/user_questionnaire?username=${T}&questionnaireId=${F}`,header:{"content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${U}`}});j.value=e.data.id,await async function(){try{const e=await d({url:`/answer/view/answers?finishId=${j.value}`,header:{"content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${U}`}});if(200===e.code)return P.value=e.data,await async function(){try{const e=await d({url:`/department/view/questions?departmentId=${D}`,header:{"content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${U}`}});R.value=e.data.questions,H.value=R.value.map((e=>{const t=P.value.filter((t=>t.questionId===e.id));if(t.length>0){if(3===t[0].type&&(e.answerContent=t[0].answerContent),2===t[0].type||1===t[0].type){const a=t.map((e=>e.optionId));e.option=e.option.filter((e=>a.includes(e.optionId)))}}else 3===e.type&&(e.answerContent="");return e}))}catch(e){console.error("获取问卷信息失败:",e)}}(),!0;401===e.data.code&&"无权限"===e.data.msg&&r({title:"此用户与您同为管理,无法查看其问卷",icon:"none",duration:2e3})}catch(e){P.value=[]}return!1}()}catch(e){console.error("获取问卷完成ID失败:",e)}}return n((async()=>{await X(),await L()})),(e,t)=>{const a=s(i("u-navbar"),m),l=g,o=f,n=A,B=s(i("u-input"),p),S=s(i("u-form-item"),_),F=s(i("u-radio"),w),T=s(i("u-radio-group"),v),j=s(i("u-form"),y),D=s(i("u-popup"),h);return b(),u(o,{class:"user-questionnaires-container"},{default:c((()=>[k(a,{title:"问卷","left-icon":"arrow-left","auto-back":"","bg-color":"#F8F8F8","title-color":"#000000",border:!1}),O?(b(),u(o,{key:0,class:"questionnaire-list"},{default:c((()=>[k(o,{class:"questionnaire-item"},{default:c((()=>[k(o,{class:"questionnaire-header"},{default:c((()=>[k(l,{class:"questionnaire-title"},{default:c((()=>[q(C(O.title),1)])),_:1})])),_:1}),k(o,{class:"questionnaire-content"},{default:c((()=>[k(l,{class:"questionnaire-description"},{default:c((()=>[q(C(O.description),1)])),_:1}),k(o,{class:"questions-list"},{default:c((()=>[(b(!0),x($,null,I(H.value,((e,t)=>(b(),u(o,{key:t,class:"question-item"},{default:c((()=>[k(o,{class:"question-header"},{default:c((()=>[k(l,{class:"question-number"},{default:c((()=>[q(C(t+1)+".",1)])),_:2},1024),k(l,{class:"question-text"},{default:c((()=>[q(C(e.content),1)])),_:2},1024),1===e.type?(b(),u(l,{key:0,class:"question-type"},{default:c((()=>[q("[单选题]")])),_:1})):2===e.type?(b(),u(l,{key:1,class:"question-type"},{default:c((()=>[q("[多选题]")])),_:1})):3===e.type?(b(),u(l,{key:2,class:"question-type"},{default:c((()=>[q("[填空题]")])),_:1})):V("",!0)])),_:2},1024),1===e.type?(b(),u(o,{key:0,class:"options"},{default:c((()=>[(b(!0),x($,null,I(e.option,((e,t)=>(b(),u(o,{key:t,class:"option-item"},{default:c((()=>[k(o,{class:"option-label"},{default:c((()=>[q(C(String.fromCharCode(65+t)),1)])),_:2},1024),k(o,{class:"option-text"},{default:c((()=>[q(C(e.optionContent),1)])),_:2},1024),k(o,{class:"checkmark"},{default:c((()=>[q("✓")])),_:1})])),_:2},1024)))),128))])),_:2},1024)):2===e.type?(b(),u(o,{key:1,class:"options"},{default:c((()=>[(b(!0),x($,null,I(e.option,((e,t)=>(b(),u(o,{key:t,class:"option-item"},{default:c((()=>[k(o,{class:"option-label"},{default:c((()=>[q(C(String.fromCharCode(65+t)),1)])),_:2},1024),k(o,{class:"option-text"},{default:c((()=>[q(C(e.optionContent),1)])),_:2},1024),k(o,{class:"checkmark"},{default:c((()=>[q("✓")])),_:1})])),_:2},1024)))),128))])),_:2},1024)):3===e.type?(b(),u(o,{key:2,class:"textarea-container"},{default:c((()=>[k(o,{class:"user-answer"},{default:c((()=>[k(l,null,{default:c((()=>[q(C(e.answerContent),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):V("",!0)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})])),_:1})):(b(),u(o,{key:1,class:"empty-state"},{default:c((()=>[k(l,{class:"empty-text"},{default:c((()=>[q("暂无问卷数据")])),_:1})])),_:1})),k(o,{class:"create-comment-button"},{default:c((()=>[k(n,{class:"comment-button",onClick:t[0]||(t[0]=e=>G.value=!0)},{default:c((()=>[q("创建评论")])),_:1})])),_:1}),k(o,{class:"comment-list-header"},{default:c((()=>[k(l,{class:"comment-list-title"},{default:c((()=>[q("评论列表")])),_:1})])),_:1}),E.value&&E.value.length>0?(b(),u(o,{key:2,class:"comment-list"},{default:c((()=>[(b(!0),x($,null,I(E.value,((e,t)=>(b(),u(o,{class:"comment-item",key:t},{default:c((()=>[k(o,{class:"comment-content-wrapper"},{default:c((()=>[k(l,{class:"comment-content"},{default:c((()=>[q(C(e.content),1)])),_:2},1024),k(l,{class:z(["comment-visibility",{visible:1===e.viewable,hidden:0===e.viewable}])},{default:c((()=>[q(C(1===e.viewable?"可见":"不可见"),1)])),_:2},1032,["class"])])),_:2},1024),k(o,{class:"comment-actions"},{default:c((()=>[k(n,{class:"update-comment-button",onClick:t=>function(e){J.id=e.id,J.content=e.content,J.viewable=e.viewable,K.value=!0}(e)},{default:c((()=>[q("更新")])),_:2},1032,["onClick"]),k(n,{class:"delete-comment-button",onClick:t=>async function(e){200===(await d({url:`/comment/delete?id=${e.id}`,header:{"content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${U}`},method:"POST"})).code?(r({title:"评论删除成功",icon:"success"}),await L()):r({title:"评论删除失败",icon:"none"})}(e)},{default:c((()=>[q("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})):V("",!0),k(D,{mode:"center",round:10,closeable:!0,show:G.value,"onUpdate:show":t[4]||(t[4]=e=>G.value=e),onClose:t[5]||(t[5]=e=>G.value=!1),customStyle:{top:"-20%"}},{default:c((()=>[k(o,{class:"comment-modal"},{default:c((()=>[k(o,{class:"modal-header"},{default:c((()=>[k(l,{class:"modal-title"},{default:c((()=>[q("创建评论")])),_:1})])),_:1}),k(o,{class:"modal-content"},{default:c((()=>[k(j,{model:N,ref_key:"commentFormRef",ref:Q},{default:c((()=>[k(S,{label:"评论内容",prop:"content"},{default:c((()=>[k(B,{modelValue:N.content,"onUpdate:modelValue":t[1]||(t[1]=e=>N.content=e),type:"textarea",placeholder:"请输入评论内容"},null,8,["modelValue"])])),_:1}),k(S,{label:"可见性",prop:"viewable"},{default:c((()=>[k(T,{modelValue:N.viewable,"onUpdate:modelValue":t[2]||(t[2]=e=>N.viewable=e)},{default:c((()=>[k(F,{name:1},{default:c((()=>[q("可见")])),_:1}),q("可见 "),k(F,{name:0},{default:c((()=>[q("不可见")])),_:1}),q("不可见 ")])),_:1},8,["modelValue"]),k(l,{class:"visibility-note"},{default:c((()=>[q("选择评论是否对用户可见")])),_:1})])),_:1})])),_:1},8,["model"])])),_:1}),k(o,{class:"modal-footer"},{default:c((()=>[k(n,{class:"modal-button cancel",onClick:t[3]||(t[3]=e=>G.value=!1)},{default:c((()=>[q("取消")])),_:1}),k(n,{class:"modal-button confirm",onClick:M},{default:c((()=>[q("确定")])),_:1})])),_:1})])),_:1})])),_:1},8,["show"]),k(D,{mode:"center",round:10,closeable:!0,show:K.value,"onUpdate:show":t[9]||(t[9]=e=>K.value=e),onClose:t[10]||(t[10]=e=>K.value=!1),customStyle:{top:"-20%"}},{default:c((()=>[k(o,{class:"comment-modal"},{default:c((()=>[k(o,{class:"modal-header"},{default:c((()=>[k(l,{class:"modal-title"},{default:c((()=>[q("更新评论")])),_:1})])),_:1}),k(o,{class:"modal-content"},{default:c((()=>[k(j,{model:J,ref:"updateCommentFormRef"},{default:c((()=>[k(S,{label:"评论内容",prop:"content"},{default:c((()=>[k(B,{modelValue:J.content,"onUpdate:modelValue":t[6]||(t[6]=e=>J.content=e),type:"textarea",placeholder:"请输入评论内容"},null,8,["modelValue"])])),_:1}),k(S,{label:"可见性",prop:"viewable"},{default:c((()=>[k(T,{modelValue:J.viewable,"onUpdate:modelValue":t[7]||(t[7]=e=>J.viewable=e)},{default:c((()=>[k(F,{name:1},{default:c((()=>[q("可见")])),_:1}),q("可见 "),k(F,{name:0},{default:c((()=>[q("不可见")])),_:1}),q("不可见 ")])),_:1},8,["modelValue"]),k(l,{class:"visibility-note"},{default:c((()=>[q("选择评论是否对用户可见")])),_:1})])),_:1})])),_:1},8,["model"])])),_:1}),k(o,{class:"modal-footer"},{default:c((()=>[k(n,{class:"modal-button cancel",onClick:t[8]||(t[8]=e=>K.value=!1)},{default:c((()=>[q("取消")])),_:1}),k(n,{class:"modal-button confirm",onClick:W},{default:c((()=>[q("确定")])),_:1})])),_:1})])),_:1})])),_:1},8,["show"])])),_:1})}}},[["__scopeId","data-v-55d44593"]]);export{S as default};
